<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Note Taker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .container {
            max-width: 800px;
            margin: auto;
        }
        .note-card {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            background-color: #ffffff;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #e2e8f0;
        }
        .status-icon {
            font-size: 1.5rem;
            cursor: pointer;
            transition: transform 0.1s ease-in-out;
            user-select: none;
        }
        .status-icon:hover {
            transform: scale(1.2);
        }
        .green {
            color: #10B981; /* Tailwind 'green-500' */
        }
        .red {
            color: #EF4444; /* Tailwind 'red-500' */
        }
    </style>
</head>
<body class="bg-gray-100 p-8">

    <div class="container mx-auto">
        <h1 class="text-3xl font-bold text-center mb-6">My Notes</h1>
        <div id="output" class="bg-white p-6 rounded-lg shadow-md">
            <!-- Notes will be rendered here -->
            <p class="text-center text-gray-500">No notes to display.</p>
        </div>
    </div>

    <script>
        // Debounce timer map to hold timers for each note
        const debounceTimers = new Map();
        
        // Status mapping and cycle logic
        const statusMap = {
            6: { label: 'Pending (Complete)', icon: '❓', color: 'text-green-500' },
            9: { label: 'Completed', icon: '✅', color: 'text-green-500' },
            7: { label: 'Pending (Abandon)', icon: '❓', color: 'text-red-500' },
            8: { label: 'Abandoned', icon: '❌', color: 'text-red-500' },
        };
        const statusCycle = [6, 9, 7, 8];

        /**
         * Renders the notes and pagination controls to the DOM.
         * This function is a replacement for your existing `renderNotes` function.
         * @param {Array} notes The notes to render.
         * @param {number} totalCount The total number of notes.
         * @param {number} page The current page number.
         */
        function renderNotes(notes, totalCount, page) {
            const output = document.getElementById('output');
            const notesHtml = notes.map(note => {
                // Get the current status from the note, defaulting to '6' if not set
                const status = note.status || 6;
                const statusInfo = statusMap[status];

                const shortContent = note.content.length > 200 ?
                    `${note.content.slice(0, 200)} <span class="text-blue-600 cursor-pointer" onclick="toggleContent(this)">[more]</span><span class="hidden">${note.content.slice(200)}</span>` :
                    note.content;

                return `
                    <div data-note-id="${note.id}" class="note-card mb-4">
                        <div class="flex-shrink-0">
                            <span
                                class="status-icon ${statusInfo.color}"
                                data-note-id="${note.id}"
                                data-status="${status}"
                                title="${statusInfo.label}"
                            >
                                ${statusInfo.icon}
                            </span>
                        </div>
                        <div class="flex-grow">
                            <p class="text-gray-600"><strong>ID:</strong> ${note.id.slice(0, 8)}</p>
                            <p class="text-gray-600"><strong>Created:</strong> ${new Date(note.created_at).toLocaleString()}</p>
                            <p class="text-gray-800 mt-2">${shortContent}</p>
                        </div>
                    </div>
                `;
            }).join('');

            const totalPages = Math.ceil(totalCount / pageSize);
            const controls = `
                <div class="flex items-center justify-between mt-4">
                    <button class="px-4 py-2 bg-blue-500 text-white rounded-lg disabled:opacity-50" onclick="changePage(${page - 1})" ${page === 1 ? 'disabled' : ''}>Previous</button>
                    <span>Page ${page} of ${totalPages}</span>
                    <button class="px-4 py-2 bg-blue-500 text-white rounded-lg disabled:opacity-50" onclick="changePage(${page + 1})" ${page === totalPages ? 'disabled' : ''}>Next</button>
                </div>
            `;
            output.innerHTML = notesHtml + controls;
            // Attach event listeners after rendering
            initEventListeners();
        }
        
        /**
         * Initializes event listeners for the status icons using event delegation.
         */
        function initEventListeners() {
            const outputContainer = document.getElementById('output');
            // Remove previous event listener to prevent duplicates
            outputContainer.removeEventListener('click', handleIconClick);
            // Add a single event listener to the parent container
            outputContainer.addEventListener('click', handleIconClick);
        }

        /**
         * The click handler for the event listener.
         * @param {Event} event The click event.
         */
        function handleIconClick(event) {
            const target = event.target.closest('.status-icon');
            if (target) {
                cycleNoteStatus(target);
            }
        }

        /**
         * Cycles the note's status and debounces the database write.
         * @param {HTMLElement} icon The clicked icon element.
         */
        function cycleNoteStatus(icon) {
            const noteId = icon.dataset.noteId;
            const currentStatus = parseInt(icon.dataset.status, 10);

            // Find the next status in the cycle
            const currentIndex = statusCycle.indexOf(currentStatus);
            const nextIndex = (currentIndex + 1) % statusCycle.length;
            const nextStatus = statusCycle[nextIndex];

            // Update the icon's display immediately
            const nextStatusInfo = statusMap[nextStatus];
            icon.textContent = nextStatusInfo.icon;
            icon.className = `status-icon ${nextStatusInfo.color}`;
            icon.dataset.status = nextStatus;
            icon.title = nextStatusInfo.label;

            // Clear any existing timer for this note
            if (debounceTimers.has(noteId)) {
                clearTimeout(debounceTimers.get(noteId));
            }

            // Set a new timer to update the database after a delay
            const timer = setTimeout(() => {
                updateNoteStatusInDB(noteId, nextStatus);
                debounceTimers.delete(noteId); // Clear the timer from the map
            }, 2000); // 2-second delay

            debounceTimers.set(noteId, timer);
        }

        /**
         * Placeholder function to update the note status.
         * Replace the contents of this function with your actual database update logic.
         * @param {string} noteId The ID of the note to update.
         * @param {number} newStatus The new status value.
         */
        function updateNoteStatusInDB(noteId, newStatus) {
            console.log(`Database update: Note ${noteId} status changed to ${newStatus}.`);
            // Add your actual database call here. For example:
            // yourApi.updateNote(noteId, { status: newStatus });
        }
        
        // Example to demonstrate the function
        const mockNotes = [
            { id: 'note123', sort_int: 1, author_id: 'user456', created_at: Date.now(), content: 'This is a sample note with some content that needs to be checked. It will be truncated for demonstration purposes. This is a very long note to test the [more] functionality. It just keeps going on and on and on and on to fill up space.' },
            { id: 'note124', sort_int: 2, author_id: 'user456', created_at: Date.now(), content: 'This is a shorter note that does not need to be truncated.', status: 9 },
            { id: 'note125', sort_int: 3, author_id: 'user456', created_at: Date.now(), content: 'Another note to test the debounce feature.', status: 7 }
        ];

        // This is a placeholder call. Your application should call `renderNotes` when your data is ready.
        window.onload = () => renderNotes(mockNotes, 20, 1);
        window.changePage = (page) => {
            console.log(`Navigating to page ${page}.`);
        };
        window.toggleContent = (element) => {
            const hiddenContent = element.nextElementSibling;
            if (hiddenContent.classList.contains('hidden')) {
                hiddenContent.classList.remove('hidden');
                element.textContent = '[less]';
            } else {
                hiddenContent.classList.add('hidden');
                element.textContent = '[more]';
            }
        };
    </script>
</body>
</html>
