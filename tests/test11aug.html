<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>23:50-aud11-Notes Test Harness</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
  <h1>🧪 Supabase Notes Test</h1>

  <button id="test-fetch">Fetch Notes</button>
  <button id="test-insert">Insert Note</button>
  <button id="test-update">Update Status</button>
  <button id="test-tags">Apply Tags to Note</button>
  <button id="test-categories">Tag Note by Category Names</button>


  <pre id="output" style="margin-top: 1em; background: #f0f0f0; padding: 1em;"></pre>



  
  <script type="module">
    import { createSupabaseClient } from './db/client.js';
    import { fetchNotes, insertNote, renderNotes, saveNoteStatus } from './db/notes.js';

   
    const supabase = createSupabaseClient();
  //  const output = document.getElementById('output');

//new tag test
 //?? Possible code
 //   import { readCategoryMap, readReverseCategoryMap, tagNoteByNames, tagNoteByIds } from './db/tags.js';

   
//import { tagNoteByNames, upsertTags, linkNoteToCategories } from './db/tags.js';


//await tagNoteByNames(noteId, tags);

//

import { tagNoteByNames, linkNoteToCategories } from './db/tags.js';

const output = document.getElementById('output');
const testButton = document.getElementById('test-categories');

// Mock data
const mockNoteId = '439ebcbb-5d58-441b-a0f3-942a90d2da7f';
const mockTags = ['refactor', 'design', 'accessibility', 'bug','diary'];

testButton.addEventListener('click', async () => {
  output.textContent = '⏳ Running tagNoteByNames test...';

  try {
    const result = await tagNoteByNames(mockNoteId, mockTags);
    output.textContent = `✅ tagNoteByNames succeeded:\n${JSON.stringify(result, null, 2)}`;
  } catch (err) {
    output.textContent = `❌ tagNoteByNames failed:\n${err.message}`;
  }

  // Optional: test linkNoteToCategories separately
  // const categoryIds = ['uuid1', 'uuid2'];
  // const linkResult = await linkNoteToCategories(mockNoteId, categoryIds);
  // output.textContent += `\n\n🔗 linkNoteToCategories result:\n${JSON.stringify(linkResult, null, 2)}`;
});




//    
    
    function log(message) {
      output.textContent += message + '\n';
      console.log(message);
    }

    document.getElementById('test-fetch').addEventListener('click', async () => {
      log('Fetching notes...');
      const { data, count } = await fetchNotes(supabase, 1);
      log(`Fetched ${data.length} notes (Total: ${count})`);
      data.forEach(note => log(`- ${note.id}: ${note.title}`));

renderNotes();
      
    });

    document.getElementById('test-insert').addEventListener('click', async () => {
      log('Inserting test note...');
      const authorId = '47742c9f-9afd-40b3-816a-f83fcd72b905'; // Replace with a valid UUID
      
      const newId = await insertNote(supabase, authorId, null, null, 'Harness test', 'This is sent from the Notes Test Harness using the new notes.js file.', 6);
      if (newId) {
        log(`✓ Inserted note with ID: ${newId}`);
      } else {
        log('✗ Insert failed');
      }
    });

    document.getElementById('test-update').addEventListener('click', async () => {
      const testNoteId = prompt('Enter note ID to update status:');
      const newStatus = parseInt(prompt('Enter new status (6, 7, 8, 9):'), 10);
      if (!testNoteId || isNaN(newStatus)) {
        log('✗ Invalid input');
        return;
      }
      log(`Updating note ${testNoteId} to status ${newStatus}...`);
      const { data, error } = await saveNoteStatus(supabase, testNoteId, newStatus);

      if (error) {
        log('✗ Update failed');
        log(JSON.stringify(error, null, 2));
      } else {
        log(`✓ Status updated`);
        log(`Updated note: ${JSON.stringify(data, null, 2)}`);
      }
    });

    // 🏷️ Tag application test
    document.getElementById('test-tags').addEventListener('click', async () => {
      const noteId = prompt('Enter note ID to tag:');
      const tagsInput = prompt('Enter comma-separated tag names:');
      if (!noteId || !tagsInput) {
        log('✗ Invalid input');
        return;
      }

document.getElementById('test-categories').addEventListener('click', async () => {
  const noteId = prompt('Enter note ID to tag:');
  const categoriesInput = prompt('Enter comma-separated category names:');
  if (!noteId || !categoriesInput) {
    log('✗ Invalid input');
    return;
  }

  const categoryNames = categoriesInput.split(',').map(c => c.trim()).filter(Boolean);
  log(`Tagging note ${noteId} with categories: ${categoryNames.join(', ')}`);

  try {
    await tagNoteByNames(noteId, categoryNames);
    log(`✓ Categories tagged successfully`);
  } catch (err) {
    log(`✗ Category tagging failed: ${err.message}`);
  }
});


      

      const tagNames = tagsInput.split(',').map(t => t.trim()).filter(Boolean);
      log(`Applying tags to note ${noteId}: ${tagNames.join(', ')}`);

      try {
        const insertedTags = await upsertTags(tagNames);
        log(`✓ Tags upserted: ${insertedTags.map(t => `${t.name} (${t.id})`).join(', ')}`);

        const tagIds = insertedTags.map(t => t.id);
        await linkNoteToCategories(noteId, tagIds);
        log(`✓ Tags linked to note ${noteId}`);
      } catch (err) {
        log(`✗ Tag application failed: ${err.message}`);
      }
    });
  </script>
</body>
</html>
